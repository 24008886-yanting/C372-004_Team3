<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Tracking | Repawblic Pets</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&family=Space+Grotesk:wght@500;700&display=swap">
  <link rel="stylesheet" href="/css/orderTracking.css">
</head>
<body>
  <%- include('partials/navbar') %>

  <main>
    <header style="margin-bottom:12px;">
      <p class="subhead">Track the delivery progress of your paid orders.</p>
      <h1>Order Tracking</h1>
    </header>

    <% if (error) { %>
      <p class="error"><%= error %></p>
    <% } %>

    <section class="card">
      <% if (orders && orders.length) { %>
        <% orders.forEach(function(order) { %>
          <article
            class="order"
            data-status="<%= (order.tracking_status || 'in_warehouse').toLowerCase() %>"
            data-start="<%= order.tracking_updated_at ? new Date(order.tracking_updated_at).toISOString() : new Date().toISOString() %>"
          >
            <div class="order-head">
              <h2>Order #<%= order.order_id %></h2>
              <span class="status">
                <%= trackingLabels[order.tracking_status] || trackingLabels.in_warehouse %>
              </span>
            </div>
            <p class="meta"><%= Number(order.units_count || 0) %> item(s) Â· Total S$<%= Number(order.total_amount || 0).toFixed(2) %></p>
            <div class="timeline" data-steps="4">
              <div class="timeline-track"></div>
              <div class="timeline-progress"></div>
              <div class="step" data-step="in_warehouse">
                <span class="dot"></span>
                <span class="label">In Warehouse</span>
              </div>
              <div class="step" data-step="sorting_centre">
                <span class="dot"></span>
                <span class="label">Sorting Centre</span>
              </div>
              <div class="step" data-step="enroute">
                <span class="dot"></span>
                <span class="label">En Route to Customer</span>
              </div>
              <div class="step" data-step="delivered">
                <span class="dot"></span>
                <span class="label">Delivered</span>
              </div>
            </div>
            <ul class="milestones">
              <li data-step="in_warehouse">
                <span class="milestone-title">In Warehouse</span>
                <span class="milestone-time" data-time>Pending</span>
              </li>
              <li data-step="sorting_centre">
                <span class="milestone-title">Sorting Centre</span>
                <span class="milestone-time" data-time>Pending</span>
              </li>
              <li data-step="enroute">
                <span class="milestone-title">En Route to Customer</span>
                <span class="milestone-time" data-time>Pending</span>
              </li>
              <li data-step="delivered">
                <span class="milestone-title">Delivered</span>
                <span class="milestone-time" data-time>Pending</span>
              </li>
            </ul>
          </article>
        <% }); %>
      <% } else { %>
        <p class="muted">You do not have any paid orders to track yet.</p>
      <% } %>
    </section>

    <a class="back-link" href="/profile">&#60; Back to Profile</a>
  </main>

  <script>
    (() => {
      const steps = ['in_warehouse', 'sorting_centre', 'enroute', 'delivered'];
      const labels = {
        in_warehouse: 'In Warehouse',
        sorting_centre: 'Sorting Centre',
        enroute: 'En Route to Customer',
        delivered: 'Delivered'
      };

      const normalizeStatus = (value) => {
        const raw = String(value || '').trim().toLowerCase();
        if (raw === 'out_for_delivery') return 'enroute';
        return steps.includes(raw) ? raw : 'in_warehouse';
      };

      const renderStatus = (card, status) => {
        const badge = card.querySelector('.status');
        if (badge) {
          badge.textContent = labels[status] || labels.in_warehouse;
          badge.className = `status status-${status}`;
        }

        const index = steps.indexOf(status);
        const stepEls = Array.from(card.querySelectorAll('.step'));
        const milestoneEls = Array.from(card.querySelectorAll('.milestones li'));
        const timeline = card.querySelector('.timeline');
        if (timeline) {
          const progress = steps.length > 1 ? (index / (steps.length - 1)) : 0;
          timeline.style.setProperty('--progress', progress.toFixed(4));

          const dots = Array.from(timeline.querySelectorAll('.dot'));
          if (dots.length >= 2) {
            const timelineRect = timeline.getBoundingClientRect();
            const firstRect = dots[0].getBoundingClientRect();
            const lastRect = dots[dots.length - 1].getBoundingClientRect();
            const left = (firstRect.left + (firstRect.width / 2)) - timelineRect.left;
            const rightCenter = (lastRect.left + (lastRect.width / 2)) - timelineRect.left;
            const width = Math.max(rightCenter - left, 0);
            const leftPx = `${Math.max(left, 0).toFixed(1)}px`;
            const widthPx = `${width.toFixed(1)}px`;
            timeline.style.setProperty('--line-left', leftPx);
            timeline.style.setProperty('--line-width', widthPx);

            const track = timeline.querySelector('.timeline-track');
            const progressBar = timeline.querySelector('.timeline-progress');
            if (track) {
              track.style.left = leftPx;
              track.style.width = widthPx;
            }
            if (progressBar) {
              progressBar.style.left = leftPx;
              progressBar.style.width = widthPx;
            }
          }
        }
        stepEls.forEach((stepEl) => {
          const stepKey = stepEl.getAttribute('data-step');
          const stepIndex = steps.indexOf(stepKey);
          stepEl.classList.remove('done', 'active');
          if (stepIndex < index) {
            stepEl.classList.add('done');
          } else if (stepIndex === index) {
            stepEl.classList.add('active');
          }
        });
        milestoneEls.forEach((milestoneEl) => {
          const stepKey = milestoneEl.getAttribute('data-step');
          const stepIndex = steps.indexOf(stepKey);
          milestoneEl.classList.remove('done', 'active');
          if (stepIndex < index) {
            milestoneEl.classList.add('done');
          } else if (stepIndex === index) {
            milestoneEl.classList.add('active');
          }
        });
      };

      const updateCard = (card) => {
        const baseStatus = normalizeStatus(card.dataset.status);
        const start = Date.parse(card.dataset.start || '');
        const startTime = Number.isFinite(start) ? start : Date.now();
        const baseIndex = steps.indexOf(baseStatus);
        const elapsedSteps = Math.floor((Date.now() - startTime) / 15000);
        const nextIndex = Math.min(steps.length - 1, baseIndex + Math.max(elapsedSteps, 0));
        const nextStatus = steps[nextIndex] || baseStatus;
        renderStatus(card, nextStatus);

        const milestoneEls = Array.from(card.querySelectorAll('.milestones li'));
        milestoneEls.forEach((milestoneEl) => {
          const stepKey = milestoneEl.getAttribute('data-step');
          const stepIndex = steps.indexOf(stepKey);
          const timeEl = milestoneEl.querySelector('[data-time]');
          if (!timeEl) return;

          if (stepIndex <= nextIndex) {
            const ts = new Date(startTime + (stepIndex * 15000));
            timeEl.textContent = ts.toLocaleString('en-SG', {
              month: 'short',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            });
          } else {
            timeEl.textContent = 'Pending';
          }
        });
      };

      const cards = Array.from(document.querySelectorAll('.order'));
      if (!cards.length) return;

      const updateAll = () => {
        cards.forEach(updateCard);
      };

      updateAll();
      window.addEventListener('resize', updateAll);
      setInterval(updateAll, 15000);
    })();
  </script>
</body>
</html>
