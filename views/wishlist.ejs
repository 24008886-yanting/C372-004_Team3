<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Wishlist | Repawblic Pets</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&display=swap">
  <%
    const resolveImage = (src) => {
      if (!src) return '/images/placeholder.png';
      if (/^(https?:)?\/\//i.test(src) || src.startsWith('data:') || src.startsWith('/images/')) return src;
      return '/images/' + src;
    };
    const hasUnavailable = Array.isArray(items) && items.some((item) => String(item.status || 'available').toLowerCase() === 'unavailable');
  %>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
      --danger: #dc2626;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Manrope', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .shell {
      max-width: 1100px;
      margin: 40px auto;
      padding: 0 20px 60px;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 28px;
    }
    .muted { color: var(--muted); margin: 0 0 20px; }
    .list {
      display: grid;
      gap: 16px;
    }
    .card {
      display: grid;
      grid-template-columns: 110px 1fr 220px;
      gap: 16px;
      padding: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      align-items: center;
    }
    .thumb {
      width: 110px;
      height: 110px;
      border-radius: 10px;
      object-fit: cover;
      background: #e5e7eb;
    }
    .title { font-weight: 700; margin: 0 0 6px; }
    .price { margin: 0; font-weight: 600; color: var(--accent); }
    .stock { margin: 6px 0 0; font-size: 13px; color: var(--muted); }
    .stock--unavailable { color: #92400e; font-weight: 700; }
    .notice {
      margin: 10px 0 0;
      padding: 10px 12px;
      border-radius: 10px;
      background: #fef9c3;
      color: #92400e;
      font-size: 13px;
      font-weight: 600;
    }
    .actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      align-items: center;
    }
    button {
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-ghost { background: #fff; color: var(--danger); border: 1px solid var(--border); }
    .qty-input {
      width: 70px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-weight: 600;
    }
    .empty {
      padding: 28px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      text-align: center;
      color: var(--muted);
    }
    .link {
      color: var(--accent);
      text-decoration: none;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <%- include('partials/navbar') %>

  <main class="shell">
    <h1>My Wishlist</h1>
    <p class="muted">Save items you love and move them to cart when you are ready to buy.</p>
    <% if (hasUnavailable) { %>
      <div class="notice">Unavailable items are locked. You can only remove them.</div>
    <% } %>

    <% if (!items || items.length === 0) { %>
      <div class="empty">
        Your wishlist is empty. <a class="link" href="/shopping">Browse products</a>.
      </div>
    <% } else { %>
      <div class="list">
        <% items.forEach(item => { 
             const status = String(item.status || 'available').toLowerCase();
             const isAvailable = status !== 'unavailable';
        %>
          <div class="card" data-id="<%= item.wishlist_id %>">
            <img class="thumb" src="<%= resolveImage(item.image1) %>" alt="<%= item.product_name %>">
            <div>
              <p class="title"><%= item.product_name %></p>
              <p class="price">$<%= Number(item.price).toFixed(2) %></p>
              <% if (!isAvailable) { %>
                <p class="stock stock--unavailable">Unavailable</p>
              <% } else { %>
                <p class="stock">In stock: <%= item.stock %></p>
              <% } %>
            </div>
            <div class="actions">
              <input class="qty-input" type="number" min="1" value="1" aria-label="Quantity" <%= isAvailable ? '' : 'disabled' %>>
              <button class="btn-accent" data-action="move-to-cart" <%= isAvailable ? '' : 'disabled' %>>Move to Cart</button>
              <button class="btn-ghost" data-action="remove">Remove</button>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </main>

  <script>
    // Minimal client-side helpers to call API endpoints without method-override
    const handleClick = async (btn) => {
      if (btn.disabled) return;
      const card = btn.closest('.card');
      const wishlistId = card?.dataset?.id;
      if (!wishlistId) return;

      const action = btn.dataset.action;
      const qtyInput = card.querySelector('.qty-input');
      const quantity = qtyInput ? Number(qtyInput.value) || 1 : 1;

      const headers = { 'Content-Type': 'application/json' };
      let resp;

      if (action === 'move-to-cart') {
        resp = await fetch(`/wishlist/${wishlistId}/move-to-cart`, {
          method: 'POST',
          headers,
          body: JSON.stringify({ quantity })
        });
      } else if (action === 'remove') {
        resp = await fetch(`/wishlist/${wishlistId}`, {
          method: 'DELETE',
          headers
        });
      }

      if (!resp) return;
      if (resp.ok) {
        // Refresh to show latest list
        window.location.reload();
      } else {
        const data = await resp.json().catch(() => ({}));
        alert(data.details || data.error || 'Action failed');
      }
    };

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (btn) {
        e.preventDefault();
        if (btn.disabled) return;
        handleClick(btn);
      }
    });
  </script>
</body>
</html>
