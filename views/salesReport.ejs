<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Report | Repawblic Pets</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&display=swap">
  <link rel="stylesheet" href="/css/shelter.css">
  <style>
    .chart-card {
      display: grid;
      gap: 12px;
    }
    .chart-wrap {
      width: 100%;
      min-height: 280px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 12px;
      background: #fff;
    }
    .chart-legend {
      display: flex;
      gap: 16px;
      align-items: center;
      font-size: 13px;
      color: var(--muted);
    }
    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #2563eb;
      display: inline-block;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <%- include('partials/navbar') %>

  <main>
    <header>
      <p class="muted">Admin</p>
      <h1>Sales Report</h1>
      <p class="muted">Gross, refunds, and net sales for the selected period</p>
    </header>

    <section class="card">
      <form method="GET" action="/admin/reports/sales" class="form-grid" style="max-width:100%;">
        <div class="form-group">
          <label for="start_date">Start Date</label>
          <input id="start_date" type="date" name="start_date" value="<%= filters.startDate || '' %>">
        </div>
        <div class="form-group">
          <label for="end_date">End Date</label>
          <input id="end_date" type="date" name="end_date" value="<%= filters.endDate || '' %>">
        </div>
        <div class="form-group">
          <label for="group_by">Group By</label>
          <select id="group_by" name="group_by">
            <option value="day" <%= (filters.groupBy || 'day') === 'day' ? 'selected' : '' %>>Day</option>
            <option value="month" <%= (filters.groupBy || 'day') === 'month' ? 'selected' : '' %>>Month</option>
          </select>
        </div>
        <div class="form-group">
          <label for="product_id">Product Trend</label>
          <select id="product_id" name="product_id">
            <option value="">Select a product</option>
            <% (products || []).forEach((p) => { %>
              <option value="<%= p.product_id %>" <%= Number(selectedProductId) === Number(p.product_id) ? 'selected' : '' %>>
                <%= p.product_name %>
              </option>
            <% }) %>
          </select>
        </div>
        <div class="form-actions">
          <button class="btn" type="submit">Apply Filters</button>
          <a class="btn outline" href="/admin/reports/sales">Reset</a>
        </div>
      </form>
    </section>

    <div class="grid" style="margin:18px 0;">
      <article class="card">
        <p>Gross Sales</p>
        <h2>$<%= Number(summary.grossSales || 0).toFixed(2) %></h2>
      </article>
      <article class="card">
        <p>Refunds Total</p>
        <h2>$<%= Number(summary.refundsTotal || 0).toFixed(2) %></h2>
      </article>
      <article class="card">
        <p>Net Sales</p>
        <h2>$<%= Number(summary.netSales || 0).toFixed(2) %></h2>
      </article>
      <article class="card">
        <p>Total Orders</p>
        <h2><%= summary.totalOrders %></h2>
      </article>
      <article class="card">
        <p>Items Sold</p>
        <h2><%= summary.totalItemsSold %></h2>
      </article>
    </div>

    <section class="card">
      <div class="table-header">
        <h2>Breakdown</h2>
      </div>

      <% if (!breakdown || !breakdown.length) { %>
        <p class="muted table-empty">No data for this range.</p>
      <% } else { %>
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Gross Sales</th>
                <th>Refunds</th>
                <th>Net Sales</th>
                <th>Order Count</th>
              </tr>
            </thead>
            <tbody>
              <% breakdown.forEach(row => { %>
                <tr>
                  <td><%= row.day %></td>
                  <td>$<%= Number(row.gross_sales || 0).toFixed(2) %></td>
                  <td>$<%= Number(row.refunds_total || 0).toFixed(2) %></td>
                  <td>$<%= Number(row.net_sales || 0).toFixed(2) %></td>
                  <td><%= row.order_count || 0 %></td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      <% } %>
    </section>

    <section class="card chart-card">
      <div class="table-header">
        <h2>Product Trend</h2>
      </div>

      <% if (!selectedProductId) { %>
        <p class="muted table-empty">Select a product to view its sales trend.</p>
      <% } else if (!productTrend || !productTrend.length) { %>
        <p class="muted table-empty">No product sales data for this range.</p>
      <% } else { %>
        <p class="muted" style="margin-top:-6px;">Product: <strong><%= selectedProduct ? selectedProduct.product_name : ('#' + selectedProductId) %></strong></p>
        <div class="chart-legend">
          <span><span class="legend-dot"></span>Net Sales</span>
        </div>
        <div id="product-trend-chart" class="chart-wrap" data-points='<%- JSON.stringify(productTrend || []) %>'></div>
      <% } %>
    </section>
  </main>

  <%- include('partials/footer') %>
  <script>
    (() => {
      const chartEl = document.getElementById('product-trend-chart');
      if (!chartEl) return;

      let points = [];
      try {
        points = JSON.parse(chartEl.getAttribute('data-points') || '[]');
      } catch (err) {
        points = [];
      }

      if (!points.length) return;

      points = points.slice().sort((a, b) => String(a.day).localeCompare(String(b.day)));

      const width = Math.max(chartEl.clientWidth, 320);
      const height = 260;
      const pad = { top: 16, right: 16, bottom: 36, left: 52 };

      const values = points.map((p) => Math.max(0, Number(p.net_sales || 0)));
      const maxVal = Math.max(1, ...values);
      const minVal = 0;
      const range = maxVal - minVal || 1;

      const xStep = (width - pad.left - pad.right) / Math.max(1, points.length - 1);
      const x = (i) => pad.left + i * xStep;
      const y = (v) => pad.top + (maxVal - v) * (height - pad.top - pad.bottom) / range;
      const y0 = y(0);

      const path = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${x(i)} ${y(Math.max(0, Number(p.net_sales || 0)))}`).join(' ');
      const area = `${path} L ${x(points.length - 1)} ${y0} L ${x(0)} ${y0} Z`;

      const ticks = 3;
      const tickValues = Array.from({ length: ticks + 1 }, (_, i) => minVal + (range * i / ticks));

      const labelIndexes = points.map((_, i) => i);

      const formatDayLabel = (raw) => {
        if (!raw) return '';
        const str = String(raw);
        if (/^\d{4}-\d{2}$/.test(str)) {
          return str;
        }
        const hourMatch = str.match(/^(\d{4})-(\d{2})-(\d{2})\s(\d{2}):(\d{2})/);
        if (hourMatch) {
          const year = Number(hourMatch[1]);
          const month = Number(hourMatch[2]) - 1;
          const day = Number(hourMatch[3]);
          const hour = Number(hourMatch[4]);
          const date = new Date(year, month, day, hour, 0, 0, 0);
          if (!Number.isNaN(date.getTime())) {
            const monthShort = date.toLocaleDateString('en-SG', { month: 'short' });
            const dayNum = date.getDate();
            const hourStr = String(date.getHours()).padStart(2, '0');
            return `${dayNum} ${monthShort} ${hourStr}:00`;
          }
        }
        const safe = str.includes('T') ? str : str.replace(' ', 'T');
        const date = new Date(safe);
        if (!Number.isNaN(date.getTime())) {
          return date.toLocaleDateString('en-SG', { month: 'short', day: 'numeric' });
        }
        return str;
      };

      const svgParts = [];
      svgParts.push(`<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" fill="none" xmlns="http://www.w3.org/2000/svg">`);
      svgParts.push(`<rect x="0" y="0" width="${width}" height="${height}" fill="#ffffff" />`);

      tickValues.forEach((val) => {
        const yPos = y(val);
        svgParts.push(`<line x1="${pad.left}" y1="${yPos}" x2="${width - pad.right}" y2="${yPos}" stroke="#e5e7eb" stroke-width="1" />`);
        svgParts.push(`<text x="${pad.left - 8}" y="${yPos + 4}" text-anchor="end" font-size="11" fill="#6b7280">$${val.toFixed(0)}</text>`);
      });

      svgParts.push(`<line x1="${pad.left}" y1="${height - pad.bottom}" x2="${width - pad.right}" y2="${height - pad.bottom}" stroke="#111827" stroke-width="1" />`);
      svgParts.push(`<line x1="${pad.left}" y1="${pad.top}" x2="${pad.left}" y2="${height - pad.bottom}" stroke="#111827" stroke-width="1" />`);

      labelIndexes.forEach((idx) => {
        const label = formatDayLabel(points[idx]?.day || '');
        const xPos = x(idx);
        svgParts.push(`<text x="${xPos}" y="${height - 12}" text-anchor="middle" font-size="10" fill="#6b7280">${label}</text>`);
      });

      svgParts.push(`<path d="${area}" fill="rgba(37, 99, 235, 0.12)" />`);
      svgParts.push(`<path d="${path}" stroke="#2563eb" stroke-width="2" fill="none" />`);

      points.forEach((p, i) => {
        const cx = x(i);
        const value = Math.max(0, Number(p.net_sales || 0));
        const cy = y(value);
        svgParts.push(`<circle cx="${cx}" cy="${cy}" r="3" fill="#2563eb" />`);
        svgParts.push(`<text x="${cx}" y="${Math.max(cy - 8, pad.top + 10)}" text-anchor="middle" font-size="10" fill="#1f2933">$${value.toFixed(0)}</text>`);
      });

      svgParts.push(`</svg>`);
      chartEl.innerHTML = svgParts.join('');
    })();
  </script>
</body>
</html>
