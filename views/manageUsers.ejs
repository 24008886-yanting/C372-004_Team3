<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - Repawblic Pets Admin</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&display=swap">
    <link rel="stylesheet" href="/css/shelter.css">
    <style>
        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .role-admin { background-color: #fee2e2; color: #991b1b; }
        .role-shelter { background-color: #dbeafe; color: #1e3a8a; }
        .role-customer { background-color: #e0e7ff; color: #3730a3; }
        .role-adopter { background-color: #fef3c7; color: #92400e; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--card);
            padding: 32px;
            border-radius: 14px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(17, 24, 39, 0.2);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        .modal-header h2 { 
            margin: 0; 
            font-size: 22px; 
            color: var(--accent);
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--muted);
            line-height: 1;
        }
        .close-btn:hover { color: var(--text); }
        .btn-delete {
            background: #ef4444;
            border-color: #ef4444;
        }
        .btn-delete:hover {
            background: #dc2626;
            border-color: #dc2626;
        }
        .btn-secondary {
            background: #6b7280;
            border-color: #6b7280;
        }
        .btn-secondary:hover {
            background: #4b5563;
            border-color: #4b5563;
        }
    </style>
</head>
<body>
    <%- include('partials/navbar') %>

    <main>
        <header>
            <p class="muted">Admin Â· User Management</p>
            <h1>Manage Users</h1>
            <p class="muted">View and manage all users in the system</p>
        </header>

        <% if (success) { %>
            <section class="card">
                <div class="alert success"><%= success %></div>
            </section>
        <% } %>

        <% if (error) { %>
            <section class="card">
                <div class="alert error"><%= error %></div>
            </section>
        <% } %>

        <section class="card">
            <div class="form-actions" style="justify-content: space-between; align-items: center;">
                <span class="muted">Total users: <%= users && users.length ? users.length : 0 %></span>
                <button class="btn" onclick="openAddUserModal()">+ Add New User</button>
            </div>

            <% if (!users || !users.length) { %>
                <p class="muted" style="margin-top:20px; text-align:center;">No users found</p>
            <% } else { %>
                <div class="table-wrap" style="margin-top:16px;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% users.forEach(user => { %>
                                <tr>
                                    <td><strong><%= user.username %></strong></td>
                                    <td><%= user.email %></td>
                                    <td><%= user.phone %></td>
                                    <td>
                                        <span class="role-badge role-<%= user.role.toLowerCase() %>">
                                            <%= user.role %>
                                        </span>
                                    </td>
                                    <td><%= new Date(user.created_at).toLocaleDateString() %></td>
                                    <td>
                                        <button 
                                            class="btn outline" 
                                            style="padding:6px 12px; font-size:13px; margin-right:6px;"
                                            data-user-id="<%= user.user_id %>"
                                            data-username="<%= user.username %>"
                                            data-email="<%= user.email %>"
                                            data-phone="<%= user.phone %>"
                                            data-address="<%= user.address || '' %>"
                                            data-role="<%= user.role %>"
                                            onclick="openEditUserModal(this)">Edit</button>
                                        <button class="btn-delete" style="padding:6px 12px; font-size:13px; border-radius:10px; border:1px solid #ef4444; font-weight:700;" onclick="openDeleteModal('<%= user.user_id %>', '<%= user.username %>')">Delete</button>
                                    </td>
                                </tr>
                            <% }); %>
                        </tbody>
                    </table>
                </div>
            <% } %>
        </section>
    </main>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New User</h2>
                <button class="close-btn" onclick="closeAddUserModal()">&times;</button>
            </div>
            <form method="POST" action="/manageUsers/add" class="form-grid">
                <div class="form-group">
                    <label for="addUsername">Username *</label>
                    <input type="text" id="addUsername" name="username" required>
                </div>
                <div class="form-group">
                    <label for="addEmail">Email *</label>
                    <input type="email" id="addEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="addPhone">Phone *</label>
                    <input type="text" id="addPhone" name="phone" required placeholder="e.g., 12345678">
                </div>
                <div class="form-group">
                    <label for="addAddress">Address</label>
                    <input type="text" id="addAddress" name="address">
                </div>
                <div class="form-group">
                    <label for="addRole">Role *</label>
                    <select id="addRole" name="role" required style="width:100%; padding:12px; border:1px solid var(--border); border-radius:10px;">
                        <option value="">Select a role</option>
                        <option value="admin">Admin</option>
                        <option value="shelter">Shelter</option>
                        <option value="customer">Customer</option>
                        <option value="adopter">Adopter</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="addPassword">Password *</label>
                    <input type="password" id="addPassword" name="password" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary btn" onclick="closeAddUserModal()">Cancel</button>
                    <button type="submit" class="btn">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit User</h2>
                <button class="close-btn" onclick="closeEditUserModal()">&times;</button>
            </div>
            <form method="POST" id="editUserForm" class="form-grid">
                <input type="hidden" id="editUserId" name="userId">
                <div class="form-group">
                    <label for="editUsername">Username *</label>
                    <input type="text" id="editUsername" name="username" required>
                </div>
                <div class="form-group">
                    <label for="editEmail">Email *</label>
                    <input type="email" id="editEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="editPhone">Phone *</label>
                    <input type="text" id="editPhone" name="phone" required>
                </div>
                <div class="form-group">
                    <label for="editAddress">Address</label>
                    <input type="text" id="editAddress" name="address">
                </div>
                <div class="form-group">
                    <label for="editRole">Role *</label>
                    <select id="editRole" name="role" required style="width:100%; padding:12px; border:1px solid var(--border); border-radius:10px;">
                        <option value="admin">Admin</option>
                        <option value="shelter">Shelter</option>
                        <option value="customer">Customer</option>
                        <option value="adopter">Adopter</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editPassword">Password (leave blank to keep current)</label>
                    <input type="password" id="editPassword" name="password">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary btn" onclick="closeEditUserModal()">Cancel</button>
                    <button type="submit" class="btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Delete User</h2>
                <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
            </div>
            <p class="muted" style="margin-bottom: 20px;">
                Are you sure you want to delete <strong id="deleteUsername"></strong>? This action cannot be undone.
            </p>
            <form method="POST" id="deleteUserForm">
                <div class="form-actions">
                    <button type="button" class="btn-secondary btn" onclick="closeDeleteModal()">Cancel</button>
                    <button type="submit" class="btn btn-delete">Delete User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Add User Modal
        function openAddUserModal() {
            document.getElementById('addUserModal').classList.add('active');
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').classList.remove('active');
        }

        // Edit User Modal
        function openEditUserModal(button) {
            const { userId, username, email, phone, address, role } = button.dataset;
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUsername').value = username;
            document.getElementById('editEmail').value = email;
            document.getElementById('editPhone').value = phone;
            document.getElementById('editAddress').value = address || '';
            document.getElementById('editRole').value = role;
            document.getElementById('editPassword').value = '';

            const form = document.getElementById('editUserForm');
            form.action = `/manageUsers/${userId}/update`;

            document.getElementById('editUserModal').classList.add('active');
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.remove('active');
        }

        // Delete Modal
        function openDeleteModal(userId, username) {
            document.getElementById('deleteUsername').textContent = username;
            const form = document.getElementById('deleteUserForm');
            form.action = `/manageUsers/${userId}/delete`;
            document.getElementById('deleteModal').classList.add('active');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const addModal = document.getElementById('addUserModal');
            const editModal = document.getElementById('editUserModal');
            const deleteModal = document.getElementById('deleteModal');

            if (event.target === addModal) closeAddUserModal();
            if (event.target === editModal) closeEditUserModal();
            if (event.target === deleteModal) closeDeleteModal();
        };
    </script>

    <%- include('partials/footer') %>
</body>
</html>
