<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inventory - Repawblic Pets</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&display=swap">
  <link rel="stylesheet" href="/css/shelter.css">
  <link rel="stylesheet" href="/css/inventory.css">
</head>
<body>
  <%- include('partials/navbar') %>
  <%
    const successMessage = messages && messages.success;
    const errorMessage = messages && messages.error;
    const deleteBlock = messages && messages.deleteBlock;
  %>

  <% if (deleteBlock) { %>
    <div class="modal-backdrop" id="delete-block-modal" role="dialog" aria-modal="true">
      <div class="modal-card">
        <button type="button" class="modal-close" data-action="close-modal" aria-label="Close">&times;</button>
        <h2>Delete blocked</h2>
        <p>Deletion is currently not allowed.</p>
        <p class="modal-reason"><%= deleteBlock.reason || 'This product is still referenced in carts or wishlists.' %></p>
        <p>Would you like to set the status to Unavailable instead?</p>
        <form method="POST" action="/products/<%= deleteBlock.productId %>/status" class="modal-actions">
          <input type="hidden" name="status" value="unavailable">
          <button type="submit" class="btn btn-status-unavailable">Set to Unavailable</button>
          <button type="button" class="btn outline" data-action="close-modal">Cancel</button>
        </form>
      </div>
    </div>
  <% } %>

  <main>
    <header>
      <p class="muted">Admin Â· Product Management</p>
      <h1>Inventory</h1>
      <p class="muted">Manage all products in your store</p>
      <% if (successMessage) { %>
        <div class="inline-alert inline-alert--success"><%= successMessage %></div>
      <% } %>
      <% if (errorMessage) { %>
        <div class="inline-alert inline-alert--error"><%= errorMessage %></div>
      <% } %>
    </header>

    <section class="card">
      <div class="table-header">
        <div class="inventory-stats">
          <span class="muted">Total: <%= products ? products.length : 0 %></span>
          <span class="muted">In Stock: <%= products ? products.filter(p => p.stock > 0).length : 0 %></span>
          <span class="muted">Out: <%= products ? products.filter(p => p.stock === 0).length : 0 %></span>
        </div>
        <a class="btn" href="/products/new">+ Add Product</a>
      </div>

      <% if (!products || !products.length) { %>
        <p class="muted table-empty">No products found</p>
      <% } else { %>
        <% const resolveImage = (src) => { %>
          <% if (!src) return ''; %>
          <% if (/^(https?:)?\/\//i.test(src) || src.startsWith('data:') || src.startsWith('/images/')) return src; %>
          <% return '/images/' + src; %>
        <% }; %>
        <div class="product-grid">
          <% products.forEach(product => { 
               const status = String(product.status || 'available').toLowerCase();
               const isAvailable = status !== 'unavailable';
               const nextStatus = isAvailable ? 'unavailable' : 'available';
          %>
            <article class="card product-card">
              <img 
                src="<%= resolveImage(product.image1) || resolveImage(product.image2) || '' %>" 
                alt="<%= product.product_name %>"
              >
              <div class="product-name"><%= product.product_name %></div>
              <div class="product-category"><%= product.category %></div>
              <div class="product-price">$<%= (Number(product.price || 0) ).toFixed(2) %></div>
              <span class="status-badge <%= isAvailable ? 'status-available' : 'status-unavailable' %>">
                <%= isAvailable ? 'Available' : 'Unavailable' %>
              </span>
              <span class="stock-badge <%= product.stock > 10 ? 'stock-in' : product.stock > 0 ? 'stock-low' : 'stock-out' %>">
                Stock: <%= product.stock %>
              </span>
              <div class="form-actions">
                <a href="/products/<%= product.product_id %>/edit" class="btn outline">Edit</a>
                <form method="POST" action="/products/<%= product.product_id %>/status" class="status-form">
                  <input type="hidden" name="status" value="<%= nextStatus %>">
                  <button type="submit" class="btn <%= isAvailable ? 'btn-status-unavailable' : 'btn-status-available' %>"><%= isAvailable ? 'Set Unavailable' : 'Set Available' %></button>
                </form>
                <form method="POST" action="/products/<%= product.product_id %>/delete" class="delete-form" onsubmit="return confirm('Delete this product?');">
                  <button type="submit" class="btn btn-danger">Delete</button>
                </form>
              </div>
            </article>
          <% }); %>
        </div>
      <% } %>
    </section>
  </main>

  <%- include('partials/footer') %>
  <script>
    (() => {
      const modal = document.getElementById('delete-block-modal');
      if (!modal) return;
      const closeButtons = Array.from(modal.querySelectorAll('[data-action="close-modal"]'));
      const closeModal = () => {
        modal.remove();
      };
      closeButtons.forEach(btn => btn.addEventListener('click', closeModal));
    })();
  </script>
</body>
</html>
