<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All Transactions | Repawblic Pets</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&family=Space+Grotesk:wght@500;700&display=swap">
  <link rel="stylesheet" href="/css/allTransaction.css">
</head>
<body>
  <%- include('partials/navbar') %>

  <main>
    <header style="margin-bottom:12px;">
      <p class="subhead">Review everything you have purchased with us.</p>
      <h1>All Transactions</h1>
    </header>

    <section class="card">
      <% if (transactions && transactions.length) { %>
        <div class="table-like">
          <span>Order ID</span>
          <span>Transaction Date</span>
          <span>Item</span>
          <span>Total Paid</span>
          <span>Refund Amt</span>
          <span>Action</span>
        </div>
        <% transactions.forEach(function(order) { %>
          <% const txnDate = order.transaction_time ? new Date(order.transaction_time).toLocaleDateString('en-SG', { dateStyle: 'medium' }) : '-'; %>
          <% const paidAmount = (order.amount != null) ? Number(order.amount).toFixed(2) : null; %>
          <% const refundStatus = String(order.refund_status || '').toUpperCase(); %>
          <% const deliveryStatus = String(order.delivery_status || '').toUpperCase(); %>
          <% const hasRefundRequest = Boolean(order.refund_id || refundStatus); %>
          <% const refundViewUrl = `/refund-request?order_id=${encodeURIComponent(order.order_id || '')}&view=1`; %>
          <% const showPending = refundStatus === 'PENDING'; %>
          <% const showRefunded = refundStatus === 'REFUNDED' || refundStatus === 'APPROVED'; %>
          <% const showComplete = deliveryStatus === 'COMPLETED'; %>
          <% const showConfirmPanel = !showPending && !showRefunded && !showComplete && (deliveryStatus === 'CONFIRMED' || refundStatus); %>
          <% const items = Array.isArray(order.items) ? order.items : []; %>
          <div class="row"
               data-order-id="<%= order.order_id || '' %>">
            <span>
              <% if (hasRefundRequest) { %>
                <a class="refund-link" href="<%= refundViewUrl %>">#<%= order.order_id || '-' %></a>
              <% } else { %>
                #<%= order.order_id || '-' %>
              <% } %>
            </span>
            <span><%= txnDate %></span>
            <span>
              <% if (items.length) { %>
                <div class="item-list">
                  <% items.forEach((item) => { %>
                    <div><%= item.name || 'Item' %> (x<%= item.quantity || 0 %>)</div>
                  <% }) %>
                </div>
              <% } else { %>
                -
              <% } %>
            </span>
            <span><%= paidAmount !== null ? ('S$' + paidAmount) : '-' %></span>
            <span><%= order.refund_amount != null ? ('S$' + Number(order.refund_amount || 0).toFixed(2)) : '-' %></span>
            <span class="action-cell">
              <% if (showPending) { %>
                <span class="status-pill status-pill--pending">Pending</span>
              <% } else if (showRefunded) { %>
                <span class="status-pill status-pill--refunded">Refunded</span>
              <% } else if (showComplete) { %>
                <span class="status-pill status-pill--complete">Transaction Complete</span>
              <% } else { %>
                <% if (!showConfirmPanel) { %>
                  <button class="confirm-btn" type="button">Confirm Delivery</button>
                <% } %>
                <div class="confirm-panel <%= showConfirmPanel ? '' : 'is-hidden' %>">
                  <% const refundUrl = `/refund-request?order_id=${encodeURIComponent(order.order_id || '')}`; %>
                  <a class="refund-link" href="<%= refundUrl %>">Refund</a>
                  <button class="no-refund-btn" type="button" data-order-id="<%= order.order_id || '' %>">No Refund</button>
                </div>
                <div class="confirm-status" aria-live="polite"></div>
              <% } %>
              <div class="review-links <%= showComplete ? '' : 'is-hidden' %>">
                <% items.forEach((item) => { %>
                  <% const productId = item.product_id; %>
                  <% if (productId) { %>
                    <% const reviewUrl = `/review/new/${encodeURIComponent(order.order_id || '')}/${encodeURIComponent(productId)}`; %>
                    <% if (item.review_id) { %>
                      <a class="confirm-btn" href="<%= reviewUrl %>">View Review: <%= item.name || 'Item' %></a>
                    <% } else { %>
                      <a class="confirm-btn" href="<%= reviewUrl %>">Write Review: <%= item.name || 'Item' %></a>
                    <% } %>
                  <% } %>
                <% }) %>
              </div>
            </span>
          </div>
        <% }); %>
      <% } else { %>
        <p class="muted">No transactions found yet.</p>
      <% } %>
    </section>

    <a class="back-link" href="javascript:history.back()">&#60; Back to Profile</a>
  </main>
  <script>
    const headers = { 'Content-Type': 'application/json' };
    document.querySelectorAll('.row').forEach((row) => {
      const confirmBtn = row.querySelector('.confirm-btn');
      const panel = row.querySelector('.confirm-panel');
      const noRefundBtn = row.querySelector('.no-refund-btn');
      const statusEl = row.querySelector('.confirm-status');

      if (confirmBtn && panel) {
        confirmBtn.addEventListener('click', async () => {
          if (row.dataset.confirmed === 'true') return;
          const orderId = row.dataset.orderId || '';
          if (!orderId) return;

          confirmBtn.disabled = true;
          if (statusEl) statusEl.textContent = 'Saving...';

          try {
            const resp = await fetch(`/orders/${orderId}/confirm-delivery`, {
              method: 'POST',
              headers,
              body: JSON.stringify({ status: 'CONFIRMED' })
            });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.success) {
              throw new Error(data.error || 'Failed to confirm delivery.');
            }

            row.dataset.confirmed = 'true';
            panel.classList.remove('is-hidden');
            confirmBtn.classList.add('is-hidden');
            if (statusEl) statusEl.textContent = '';
          } catch (err) {
            if (statusEl) statusEl.textContent = err.message || 'Failed to confirm delivery.';
            confirmBtn.disabled = false;
          }
        }, { once: true });
      }

      if (noRefundBtn && panel) {
        noRefundBtn.addEventListener('click', async () => {
          const orderId = noRefundBtn.getAttribute('data-order-id');
          if (!orderId) return;

          noRefundBtn.disabled = true;
          if (statusEl) statusEl.textContent = 'Saving...';

          try {
            const resp = await fetch(`/orders/${orderId}/confirm-delivery`, {
              method: 'POST',
              headers,
              body: JSON.stringify({ status: 'COMPLETED' })
            });
            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.success) {
              throw new Error(data.error || 'Failed to confirm delivery.');
            }

            row.dataset.confirmed = 'true';
            panel.classList.add('is-hidden');
            if (confirmBtn) confirmBtn.classList.add('is-hidden');
            if (statusEl) statusEl.textContent = '';

            const statusPill = document.createElement('span');
            statusPill.className = 'status-pill status-pill--complete';
            statusPill.textContent = 'Transaction Complete';
            const actionCell = row.querySelector('.action-cell');
            actionCell?.appendChild(statusPill);

            const reviewLinks = row.querySelector('.review-links');
            if (reviewLinks) reviewLinks.classList.remove('is-hidden');
          } catch (err) {
            if (statusEl) statusEl.textContent = err.message || 'Failed to confirm delivery.';
            noRefundBtn.disabled = false;
          }
        });
      }
    });
  </script>
</body>
</html>
