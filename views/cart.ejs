<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Cart | Repawblic Pets</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&display=swap">
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
      --danger: #dc2626;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Manrope', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .shell {
      max-width: 1100px;
      margin: 40px auto;
      padding: 0 20px 60px;
      display: grid;
      gap: 20px;
      grid-template-columns: 2fr 1fr;
      align-items: start;
    }
    h1 { margin: 0 0 8px; font-size: 28px; }
    .muted { color: var(--muted); margin: 0 0 12px; }
    .list { display: grid; gap: 16px; }
    .card {
      display: grid;
      grid-template-columns: 110px 1fr 240px;
      gap: 16px;
      padding: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      align-items: center;
    }
    .thumb {
      width: 110px; height: 110px;
      border-radius: 10px;
      object-fit: cover;
      background: #e5e7eb;
    }
    .title { font-weight: 700; margin: 0 0 6px; }
    .price { margin: 0; font-weight: 600; color: var(--accent); }
    .stock { margin: 6px 0 0; font-size: 13px; color: var(--muted); }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
    button {
      border: none; border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600; cursor: pointer;
    }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-ghost { background: #fff; color: var(--danger); border: 1px solid var(--border); }
    .btn-light { background: #fff; color: var(--text); border: 1px solid var(--border); }
    .qty-input {
      width: 80px; padding: 8px;
      border-radius: 8px; border: 1px solid var(--border);
      font-weight: 600;
    }
    .summary {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      position: sticky;
      top: 20px;
    }
    .row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .row.total { font-weight: 700; font-size: 18px; margin-top: 12px; }
    .empty {
      grid-column: 1 / -1;
      padding: 28px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      text-align: center;
      color: var(--muted);
    }
    .link { color: var(--accent); text-decoration: none; font-weight: 700; }
  </style>
</head>
<body>
  <%- include('partials/navbar') %>

  <main class="shell">
    <section>
      <h1>My Cart</h1>
      <p class="muted">Adjust quantities, move items to wishlist, or remove them before checkout.</p>

      <% if (!items || items.length === 0) { %>
        <div class="empty">
          Your cart is empty. <a class="link" href="/shopping">Continue shopping</a>.
        </div>
      <% } else { %>
        <div class="list">
          <% items.forEach(item => { %>
            <div class="card" data-id="<%= item.cart_id %>">
              <img class="thumb" src="<%= item.image1 || '/images/placeholder.png' %>" alt="<%= item.product_name %>">
              <div>
                <p class="title"><%= item.product_name %></p>
                <p class="price">$<%= Number(item.price).toFixed(2) %></p>
                <p class="stock">In stock: <%= item.stock %></p>
              </div>
              <div class="actions">
                <input class="qty-input" type="number" min="1" value="<%= item.quantity %>" aria-label="Quantity">
                <button class="btn-accent" data-action="update">Update Qty</button>
                <button class="btn-light" data-action="move-to-wishlist">Move to Wishlist</button>
                <button class="btn-ghost" data-action="remove">Remove</button>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>
    </section>

    <aside class="summary">
      <div class="row"><span>Items</span><span><%= items ? items.length : 0 %></span></div>
      <% 
        let subtotal = 0;
        if (items && items.length) {
          items.forEach(i => subtotal += Number(i.price) * Number(i.quantity));
        }
      %>
      <div class="row"><span>Subtotal</span><span>$<%= subtotal.toFixed(2) %></span></div>
      <div class="row total"><span>Total</span><span>$<%= subtotal.toFixed(2) %></span></div>
      <button class="btn-accent" style="width:100%; margin-top:12px;" data-action="checkout">Checkout</button>
      <button class="btn-light" style="width:100%; margin-top:8px;" data-action="clear">Clear Cart</button>
    </aside>
  </main>

  <script>
    const headers = { 'Content-Type': 'application/json' };

    const handleCartAction = async (btn) => {
      const card = btn.closest('.card');
      const cartId = card?.dataset?.id;
      const action = btn.dataset.action;
      const qtyInput = card?.querySelector('.qty-input');
      const quantity = qtyInput ? Number(qtyInput.value) || 1 : 1;

      let resp;
      if (action === 'update') {
        resp = await fetch(`/cart/${cartId}`, {
          method: 'PUT',
          headers,
          body: JSON.stringify({ quantity })
        });
      } else if (action === 'remove') {
        resp = await fetch(`/cart/${cartId}`, { method: 'DELETE', headers });
      } else if (action === 'move-to-wishlist') {
        resp = await fetch(`/wishlist/move-from-cart/${cartId}`, {
          method: 'POST',
          headers
        });
      } else if (action === 'clear') {
        resp = await fetch(`/cart`, { method: 'DELETE', headers });
      } else if (action === 'checkout') {
        resp = await fetch(`/cart/checkout`, {
          method: 'POST',
          headers,
          body: JSON.stringify({})
        });
      }

      if (!resp) return;
      if (resp.ok) {
        if (action === 'checkout') {
          const data = await resp.json().catch(() => ({}));
          alert('Checkout successful');
          // If you have an invoice page, redirect using data.order.order_id
          return window.location.reload();
        }
        window.location.reload();
      } else {
        const data = await resp.json().catch(() => ({}));
        alert(data.error || 'Action failed');
      }
    };

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      e.preventDefault();
      handleCartAction(btn);
    });
  </script>
</body>
</html>
