<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Cart | Repawblic Pets</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;600;700&display=swap">
  <%
    const resolveImage = (src) => {
      if (!src) return '/images/placeholder.png';
      if (/^(https?:)?\/\//i.test(src) || src.startsWith('data:') || src.startsWith('/images/')) return src;
      return '/images/' + src;
    };
    const role = (userRole || '').toLowerCase();
    const isAdopter = role === 'adopter';
    const formatDiscount = (voucher) => {
      if (voucher.discount_type === 'percentage') {
        const val = Number(voucher.discount_value) || 0;
        return `${val}% off`;
      }
      const val = Number(voucher.discount_value);
      const money = Number.isFinite(val) ? val.toFixed(2) : '0.00';
      return `$${money} off`;
    };
    const now = new Date();
    const availableVouchers = (Array.isArray(vouchers) ? vouchers : []).filter((voucher) => {
      const allowedRole = String(voucher.allowed_role || '').toLowerCase();
      if (allowedRole && allowedRole !== 'adopter') return false;
      const expiry = voucher.expiry_date ? new Date(voucher.expiry_date) : null;
      if (expiry && expiry < now) return false;
      const usageLimit = Number(voucher.usage_limit || 0);
      const usedCount = Number(voucher.used_count || 0);
      if (usageLimit > 0 && usedCount >= usageLimit) return false;
      return true;
    });
    const hasUnavailable = Array.isArray(items) && items.some((item) => String(item.status || 'available').toLowerCase() === 'unavailable');
  %>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --accent: #2563eb;
      --danger: #dc2626;
      --border: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Manrope', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .shell {
      max-width: 1100px;
      margin: 40px auto;
      padding: 0 20px 60px;
      display: grid;
      gap: 20px;
      grid-template-columns: 2fr 1fr;
      align-items: start;
    }
    h1 { margin: 0 0 8px; font-size: 28px; }
    .muted { color: var(--muted); margin: 0 0 12px; }
    .list { display: grid; gap: 16px; }
    .card {
      display: grid;
      grid-template-columns: 110px 1fr 240px;
      gap: 16px;
      padding: 16px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      align-items: center;
    }
    .thumb {
      width: 110px; height: 110px;
      border-radius: 10px;
      object-fit: cover;
      background: #e5e7eb;
    }
    .title { font-weight: 700; margin: 0 0 6px; }
    .price { margin: 0; font-weight: 600; color: var(--accent); }
    .stock { margin: 6px 0 0; font-size: 13px; color: var(--muted); }
    .stock--unavailable { color: #92400e; font-weight: 700; }
    .notice {
      margin: 10px 0 0;
      padding: 10px 12px;
      border-radius: 10px;
      background: #fef9c3;
      color: #92400e;
      font-size: 13px;
      font-weight: 600;
    }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }
    button {
      border: none; border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600; cursor: pointer;
    }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-ghost { background: #fff; color: var(--danger); border: 1px solid var(--border); }
    .btn-light { background: #fff; color: var(--text); border: 1px solid var(--border); }
    .qty-input {
      width: 80px; padding: 8px;
      border-radius: 8px; border: 1px solid var(--border);
      font-weight: 600;
    }
    .summary {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      position: sticky;
      top: 20px;
    }
    .voucher-list {
      display: grid;
      gap: 8px;
      margin-top: 10px;
    }
    .voucher-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      font-size: 13px;
    }
    .voucher-code {
      font-weight: 700;
    }
    .row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .row.total { font-weight: 700; font-size: 18px; margin-top: 12px; }
    .empty {
      grid-column: 1 / -1;
      padding: 28px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      text-align: center;
      color: var(--muted);
    }
    .link { color: var(--accent); text-decoration: none; font-weight: 700; }
  </style>
</head>
<body>
  <%- include('partials/navbar') %>

  <main class="shell">
    <section>
      <h1>My Cart</h1>
      <p class="muted">Adjust quantities, move items to wishlist, or remove them before checkout.</p>
      <% if (hasUnavailable) { %>
        <div class="notice">Unavailable items are locked. You can only remove them.</div>
      <% } %>

      <% if (!items || items.length === 0) { %>
        <div class="empty">
          Your cart is empty. <a class="link" href="/shopping">Continue shopping</a>.
        </div>
      <% } else { %>
        <div class="list">
          <% items.forEach(item => { 
               const status = String(item.status || 'available').toLowerCase();
               const isAvailable = status !== 'unavailable';
          %>
            <div class="card" data-id="<%= item.cart_id %>">
              <img class="thumb" src="<%= resolveImage(item.image1) %>" alt="<%= item.product_name %>">
              <div>
                <p class="title"><%= item.product_name %></p>
                <p class="price">$<%= Number(item.price).toFixed(2) %></p>
                <% if (!isAvailable) { %>
                  <p class="stock stock--unavailable">Unavailable</p>
                <% } else { %>
                  <p class="stock">In stock: <%= item.stock %></p>
                <% } %>
              </div>
              <div class="actions">
                <input class="qty-input" type="number" min="1" value="<%= item.quantity %>" aria-label="Quantity" <%= isAvailable ? '' : 'disabled' %>>
                <button class="btn-accent" data-action="update" <%= isAvailable ? '' : 'disabled' %>>Update Qty</button>
                <button class="btn-light" data-action="move-to-wishlist" <%= isAvailable ? '' : 'disabled' %>>Move to Wishlist</button>
                <button class="btn-ghost" data-action="remove">Remove</button>
              </div>
            </div>
          <% }) %>
        </div>
      <% } %>
    </section>

    <% 
      let subtotal = 0;
      if (items && items.length) {
        items.forEach(i => subtotal += Number(i.price) * Number(i.quantity));
      }
      const shippingFee = subtotal >= 60 ? 0 : (subtotal > 0 ? 5 : 0);
      const taxRatePercent = 9;
      const taxAmount = subtotal * (taxRatePercent / 100);
      const discountAmount = 0;
      const total = subtotal + shippingFee + taxAmount - discountAmount;
    %>
    <aside class="summary" data-subtotal="<%= subtotal.toFixed(2) %>" data-shipping-fee="<%= shippingFee.toFixed(2) %>" data-tax-rate="<%= taxRatePercent %>">
      <div class="row"><span>Items</span><span><%= items ? items.length : 0 %></span></div>
      <div class="row"><span>Subtotal</span><span id="subtotal-value">$<%= subtotal.toFixed(2) %></span></div>
      <div class="row"><span>Shipping fee</span><span id="shipping-fee">$<%= shippingFee.toFixed(2) %></span></div>
      <div class="row"><span>Tax (9%)</span><span id="tax-amount">$<%= taxAmount.toFixed(2) %></span></div>
      <div class="row"><span>Discount</span><span id="discount-amount">-$<%= discountAmount.toFixed(2) %></span></div>
      <div style="margin-top: 12px;">
        <label for="voucher-code" class="muted" style="display:block; margin-bottom:6px;">Voucher code</label>
        <div style="display:flex; gap:8px;">
          <input id="voucher-code" class="qty-input" style="flex:1;" type="text" placeholder="Enter code">
          <button class="btn-light" id="apply-voucher" type="button">Apply</button>
        </div>
        <div id="voucher-status" class="muted" style="margin-top:6px;"></div>
        <% if (isAdopter && availableVouchers.length) { %>
          <div class="voucher-list">
            <% availableVouchers.forEach(voucher => { %>
              <div class="voucher-item">
                <div>
                  <div class="voucher-code"><%= voucher.voucher_code %></div>
                  <div class="muted"><%= formatDiscount(voucher) %><%= voucher.description ? ' - ' + voucher.description : '' %></div>
                </div>
                <button class="btn-light" type="button" data-voucher-code="<%= voucher.voucher_code %>">Use</button>
              </div>
            <% }) %>
          </div>
        <% } %>
      </div>
      <div class="row total"><span>Total</span><span id="total-amount">$<%= total.toFixed(2) %></span></div>
      <div id="paypal-button-container" style="margin-top:12px;"></div>
      <div id="paypal-message" class="muted" style="margin-top:6px;"></div>
      <button class="btn-light" style="width:100%; margin-top:8px;" data-action="clear">Clear Cart</button>
    </aside>
  </main>

  <% if (paypalClientId) { %>
    <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=SGD"></script>
  <% } %>
  <script>
    const headers = { 'Content-Type': 'application/json' };
    const summary = document.querySelector('.summary');
    const subtotal = Number(summary?.dataset?.subtotal || 0);
    const shippingFee = Number(summary?.dataset?.shippingFee || 0);
    const taxRatePercent = Number(summary?.dataset?.taxRate || 0);
    const paypalClientId = "<%= paypalClientId || '' %>";
    const hasUnavailable = <%= hasUnavailable ? 'true' : 'false' %>;
    const paypalButtonContainer = document.getElementById('paypal-button-container');
    const paypalMessage = document.getElementById('paypal-message');
    let voucherId = null;
    let voucherCode = '';
    let discountAmount = 0;

    const updateTotals = () => {
      const taxAmount = subtotal * (taxRatePercent / 100);
      const total = subtotal + shippingFee + taxAmount - discountAmount;
      const taxAmountEl = document.getElementById('tax-amount');
      const discountAmountEl = document.getElementById('discount-amount');
      const totalEl = document.getElementById('total-amount');
      if (taxAmountEl) taxAmountEl.textContent = `$${taxAmount.toFixed(2)}`;
      if (discountAmountEl) discountAmountEl.textContent = `-$${discountAmount.toFixed(2)}`;
      if (totalEl) totalEl.textContent = `$${total.toFixed(2)}`;
    };

    const applyVoucherBtn = document.getElementById('apply-voucher');
    if (applyVoucherBtn) {
      applyVoucherBtn.addEventListener('click', async () => {
        const codeInput = document.getElementById('voucher-code');
        const statusEl = document.getElementById('voucher-status');
        const code = codeInput?.value?.trim();
        if (!code) {
          if (statusEl) statusEl.textContent = 'Please enter a voucher code.';
          return;
        }

        applyVoucherBtn.disabled = true;
        try {
          const taxAmount = subtotal * (taxRatePercent / 100);
          const totalBeforeDiscount = subtotal + shippingFee + taxAmount;
          const res = await fetch('/vouchers/apply', {
            method: 'POST',
            headers,
            body: JSON.stringify({ code, subtotal: totalBeforeDiscount })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            const message = data?.error || data?.details || 'Failed to apply voucher.';
            if (statusEl) statusEl.textContent = message;
            voucherId = null;
            voucherCode = '';
            discountAmount = 0;
            updateTotals();
            return;
          }
          const voucher = data.voucher || {};
          voucherId = voucher.voucher_id || null;
          voucherCode = voucher.voucher_code || '';
          discountAmount = Number(voucher.discount_amount) || 0;
          if (statusEl) statusEl.textContent = `Applied ${voucher.voucher_code || 'voucher'} (-$${discountAmount.toFixed(2)}).`;
          updateTotals();
        } finally {
          applyVoucherBtn.disabled = false;
        }
      });
    }

    document.addEventListener('click', (e) => {
      const voucherBtn = e.target.closest('button[data-voucher-code]');
      if (!voucherBtn) return;
      const code = voucherBtn.getAttribute('data-voucher-code') || '';
      const codeInput = document.getElementById('voucher-code');
      if (codeInput) {
        codeInput.value = code;
      }
      if (applyVoucherBtn) {
        applyVoucherBtn.click();
      }
    });

    const handleCartAction = async (btn) => {
      if (btn.disabled) return;
      const card = btn.closest('.card');
      const cartId = card?.dataset?.id;
      const action = btn.dataset.action;
      const qtyInput = card?.querySelector('.qty-input');
      const quantity = qtyInput ? Number(qtyInput.value) || 1 : 1;

      let resp;
      if (action === 'update') {
        resp = await fetch(`/cart/${cartId}`, {
          method: 'PUT',
          headers,
          body: JSON.stringify({ quantity })
        });
      } else if (action === 'remove') {
        resp = await fetch(`/cart/${cartId}`, { method: 'DELETE', headers });
      } else if (action === 'move-to-wishlist') {
        resp = await fetch(`/wishlist/move-from-cart/${cartId}`, {
          method: 'POST',
          headers
        });
      } else if (action === 'clear') {
        resp = await fetch(`/cart`, { method: 'DELETE', headers });
      } else if (action === 'checkout') {
        resp = await fetch(`/cart/checkout`, {
          method: 'POST',
          headers,
          body: JSON.stringify({
            voucher_id: voucherId,
            discount_amount: discountAmount,
            shipping_fee: shippingFee,
            tax_rate: taxRatePercent
          })
        });
      }

      if (!resp) return;
      if (resp.ok) {
        if (action === 'checkout') {
          const data = await resp.json().catch(() => ({}));
          // Redirect to invoice confirmation page after successful checkout
          if (data.success) {
            return window.location.href = '/invoice-confirmation';
          }
        }
        window.location.reload();
      } else {
        const data = await resp.json().catch(() => ({}));
        const errorMsg = data.message || data.details || data.error || 'Action failed';
        if (action === 'checkout') {
          alert('Checkout Error: ' + errorMsg);
          return window.location.reload();
        }
        alert(errorMsg);
      }
    };

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      if (btn.disabled) return;
      e.preventDefault();
      handleCartAction(btn);
    });

    const showPaypalMessage = (message, isError = false) => {
      if (!paypalMessage) return;
      paypalMessage.textContent = message || '';
      paypalMessage.style.color = isError ? '#dc2626' : 'var(--muted)';
    };

    let paypalRendered = false;
    const renderPaypalButtons = () => {
      if (paypalRendered) return;
      if (!paypalButtonContainer) return;
      if (hasUnavailable) {
        showPaypalMessage('Unavailable items cannot be checked out. Please remove them to continue.', true);
        return;
      }
      if (!paypalClientId) {
        showPaypalMessage('PayPal is not configured. Please contact support.', true);
        return;
      }
      if (typeof paypal === 'undefined') {
        showPaypalMessage('Loading PayPal...', false);
        setTimeout(renderPaypalButtons, 300);
        return;
      }

      paypalRendered = true;
      paypal.Buttons({
        style: { shape: 'rect', color: 'blue', layout: 'vertical', label: 'paypal' },
        onClick: () => showPaypalMessage(''),
        createOrder: async () => {
          showPaypalMessage('Creating PayPal order...');
          const resp = await fetch('/paypal/create-order', {
            method: 'POST',
            headers,
            body: JSON.stringify({ voucher_code: voucherCode || null })
          });
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok || !data.id) {
            throw new Error(data.error || 'Unable to start PayPal payment.');
          }
          showPaypalMessage('');
          return data.id;
        },
        onApprove: async (data) => {
          showPaypalMessage('Capturing payment...');
          const resp = await fetch('/paypal/capture-order', {
            method: 'POST',
            headers,
            body: JSON.stringify({ orderId: data.orderID, voucher_code: voucherCode || null })
          });
          const result = await resp.json().catch(() => ({}));
          if (!resp.ok || !result.success) {
            throw new Error(result.error || 'Payment capture failed.');
          }
          const redirectUrl = result.redirectUrl || '/invoice-confirmation';
          window.location.href = redirectUrl;
        },
        onError: (err) => {
          console.error('PayPal error', err);
          showPaypalMessage(err?.message || 'Payment could not be completed. Please try again.', true);
        },
        onCancel: () => {
          showPaypalMessage('Payment was cancelled.', true);
        }
      }).render('#paypal-button-container');
    };

    renderPaypalButtons();
  </script>
</body>
</html>
