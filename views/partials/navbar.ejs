<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/navbar.css">

<%
  const resolvedRole = (
    (typeof currentRole !== 'undefined' && currentRole) ||
    (typeof currentUser !== 'undefined' && currentUser?.role) ||
    (typeof user !== 'undefined' && user?.role) ||
    (typeof userRole !== 'undefined' && userRole) ||
    (typeof role !== 'undefined' && role) ||
    ''
  ).toLowerCase();
  const isAdmin = resolvedRole === 'admin';
  const isShelter = resolvedRole === 'shelter';
  const isLoggedIn =
    Boolean(
      (typeof currentUser !== 'undefined' && currentUser) ||
      (typeof user !== 'undefined' && user)
    );
%>

<header class="rp-nav">
  <div class="rp-nav__top">
    <div class="rp-brand">Repawblic Pets</div>
    <div class="rp-icons">
      <% if (isAdmin || isShelter) { %>
        <a class="icon-btn icon-btn--profile" aria-label="Profile" href="/profile">
          <img src="/images/profile-icon.jpg" alt="Profile">
        </a>
      <% } else { %>
        <a class="icon-btn icon-btn--profile" aria-label="Profile" href="/profile">
          <img src="/images/profile-icon.jpg" alt="Profile">
        </a>
        <button class="icon-btn icon-btn--search" aria-label="Search">
          <img src="/images/search-icon.png" alt="Search">
        </button>
        <a class="icon-btn icon-btn--wishlist" aria-label="Wishlist" href="/wishlist">
          <img src="/images/wishlist-logo.jpg" alt="Wishlist">
        </a>
        <a class="icon-btn icon-btn--cart" aria-label="Cart" href="/cart">
          <img src="/images/cart-icon.jpg" alt="Cart">
        </a>
      <% } %>
    </div>
  </div>

  <nav class="rp-links">
    <% if (isAdmin) { %>
      <a href="/manageUsers">Manage Users</a>
      <a href="/inventory">Inventory</a>
      <a href="/vouchers">Vouchers</a>
      <a href="/orderDashboard">Order Dashboard</a>
      <a href="/admin/reports/sales">Sales Report</a>
      <a href="/admin/refunds">Refunds</a>
      <a href="/admin/reviews">Reviews</a>
      <a href="/admin/messages">Messages</a>
      <a href="/admin/risk-flags">Risk Flags</a>
      <a href="/shelter">Shelters</a>

    <% } else if (isShelter) { %>
      <a href="/contact">Contact Us</a>
      <a href="/adoptedList">List of adopted details</a>
      <a href="/addAdopter">Add New Adopter</a>
      
    <% } else { %>
      <a href="/">Home</a>
      <a href="/shopping">Product</a>
      <a href="/contact">Contact Us</a>
    <% } %>

    <% if (isLoggedIn) { %>
      <span class="rp-links__push"></span>
      <a href="/logout" class="rp-links__logout">Logout</a>
    <% } %>
  </nav>
</header>

<section id="product-search-overlay" class="search-overlay" aria-hidden="true">
  <div class="search-dialog" role="dialog" aria-modal="true" aria-labelledby="product-search-label">
    <div class="search-header">
      <input id="product-search-input" class="search-input" type="search" placeholder="Search products..." aria-label="Search products">
      <button class="search-close" type="button" data-close-search aria-label="Close search overlay">&times;</button>
    </div>
    <div class="search-status" id="product-search-label">Type to search for products.</div>
    <div class="search-results" role="list"></div>
  </div>
</section>

<script>
  (() => {
    const searchButton = document.querySelector('.icon-btn--search');
    const searchOverlay = document.getElementById('product-search-overlay');
    const searchInput = document.getElementById('product-search-input');
    const searchResults = document.querySelector('.search-results');
    const searchStatus = document.querySelector('.search-status');
    const closeSearchBtn = document.querySelector('[data-close-search]');
    let searchAbort = null;
    let searchTimer = null;

    const resolveImage = (src) => {
      if (!src) return '';
      if (/^(https?:)?\/\//i.test(src) || src.startsWith('data:') || src.startsWith('/images/')) return src;
      return '/images/' + src;
    };

    const clearSearchResults = (message) => {
      if (searchResults) searchResults.innerHTML = '';
      if (searchStatus) searchStatus.textContent = message;
    };

    const closeSearch = () => {
      if (!searchOverlay) return;
      searchOverlay.classList.remove('is-open');
      searchOverlay.setAttribute('aria-hidden', 'true');
      document.body.classList.remove('no-scroll');
      clearSearchResults('Type to search for products.');
      if (searchInput) searchInput.value = '';
      if (searchAbort) searchAbort.abort();
    };

    const openSearch = () => {
      if (!searchOverlay || !searchInput) return;
      searchOverlay.classList.add('is-open');
      searchOverlay.setAttribute('aria-hidden', 'false');
      document.body.classList.add('no-scroll');
      clearSearchResults('Type to search for products.');
      searchInput.value = '';
      searchInput.focus();
    };

    const createResultItem = (product) => {
      const imageUrl = resolveImage(product.image1) || resolveImage(product.image2) || '';
      const price = Number(product.price) || 0;
      const category = product.category || 'Uncategorized';
      const inStock = Number(product.stock) > 0;

      return `
        <a class="search-result" href="/product/${product.product_id}" role="listitem">
          <div class="search-thumb">
            ${imageUrl ? `<img src="${imageUrl}" alt="${product.product_name || 'Product'}">` : '<div class="search-thumb__placeholder"></div>'}
            <span class="search-thumb__stock ${inStock ? '' : 'out'}">${inStock ? 'In stock' : 'Out of stock'}</span>
          </div>
          <div class="search-copy">
            <div class="search-name">${product.product_name || 'Product'}</div>
            <div class="search-meta">${category}</div>
          </div>
          <div class="search-price">$${price.toFixed(2)}</div>
        </a>
      `;
    };

    const renderSearchResults = (items) => {
      if (!searchResults) return;
      searchResults.innerHTML = '';

      if (!items.length) {
        searchStatus.textContent = 'No products match that search.';
        return;
      }

      searchStatus.textContent = `${items.length} product${items.length === 1 ? '' : 's'} found`;
      const html = items.map(createResultItem).join('');
      searchResults.innerHTML = html;
    };

    const runSearch = async (term) => {
      if (searchAbort) searchAbort.abort();
      searchAbort = new AbortController();

      try {
        const res = await fetch(`/products/search?q=${encodeURIComponent(term)}`, { signal: searchAbort.signal });
        if (!res.ok) throw new Error('Search failed');
        const data = await res.json();
        const items = Array.isArray(data.products) ? data.products : [];
        renderSearchResults(items);
      } catch (err) {
        if (err.name === 'AbortError') return;
        console.error(err);
        searchStatus.textContent = 'Could not search products right now.';
      }
    };

    if (searchButton && searchOverlay && searchInput) {
      searchButton.addEventListener('click', (e) => {
        e.preventDefault();
        openSearch();
      });

      closeSearchBtn?.addEventListener('click', closeSearch);

      searchOverlay.addEventListener('click', (e) => {
        if (e.target === searchOverlay) closeSearch();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && searchOverlay.classList.contains('is-open')) {
          closeSearch();
        }
      });

      searchInput.addEventListener('input', () => {
        const term = searchInput.value.trim();
        if (!term) {
          clearTimeout(searchTimer);
          clearSearchResults('Type to search for products.');
          if (searchAbort) searchAbort.abort();
          return;
        }

        searchStatus.textContent = 'Searching...';
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => runSearch(term), 180);
      });
    }
  })();
</script>
